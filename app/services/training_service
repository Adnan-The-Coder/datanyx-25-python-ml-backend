from training.trainer import run_training_pipeline
from concurrent.futures import ThreadPoolExecutor
from fastapi import HTTPException
import asyncio

# Use a ThreadPoolExecutor for CPU-bound tasks like training
executor = ThreadPoolExecutor(max_workers=2)

def start_model_training(module_name: str):
    """
    Triggers the model training in a separate thread to prevent blocking 
    FastAPI's main event loop (ASGI is asynchronous, ML training is synchronous).
    """
    if module_name not in ['all', 'diagnosis', 'severity', 'warning']:
        raise HTTPException(status_code=400, detail="Invalid module name. Must be 'all', 'diagnosis', 'severity', or 'warning'.")

    # Use asyncio to run the synchronous training function in the thread pool
    loop = asyncio.get_event_loop()
    future = loop.run_in_executor(executor, run_training_pipeline, module_name)
    
    # We don't await the result here, the task runs in the background
    return future